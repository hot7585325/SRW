<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Three.js GLTFLoader Example</title>
    <!-- 網頁用Console -->
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>  var vConsole = new VConsole();  </script> -->

    <!-- GLTFLoader中的import有使用 from 'three';，如果不用importmap會導致找不到模組 -->
    <script type="importmap">
    {
        "imports": 
            {
                "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js"
            }
    }
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link rel="stylesheet" href="style.css">

</head>




<body>
    <div id="MobilePanel">

        <div id="TitlePanel">
            <h1>地形設施模擬</h1>
        </div>


        <div id="ButtonPanel">
            <button id="ShowMark">顯示Mark</button>
            <button id="TubeAni"> 管線動畫</button>
            <button id="Solo_A"> Solo模式</button>
        </div>

        <div class="InfoPanel" id="InfoPanel_A">
            <h1> 水利設施A的簡介</h1>
            <p>這裡是內容</p>
            <!-- <button id="infobtn_A">關閉</button> -->
        </div>
        <div class="InfoPanel" id="InfoPanel_B">
            <h1> 水利設施B的簡介</h1>
            <p>這裡是內容</p>
            <!-- <button id="infobtn_B">關閉</button> -->
        </div>

    </div>

    <script type="module">
        // cdn方式(官方)
        import * as THREE from 'three';
        import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/controls/OrbitControls.js";
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/loaders/GLTFLoader.js';
        import { AnimationMixer } from 'three';
        import { ECP } from "./ECP_ThreeMidth.js";
        // 建立場景
        const scene = new THREE.Scene();
        // scene.background = new THREE.Color(255, 0, 0);

        const ecp = new ECP();


        // 相機
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 5);

        //狀態開關
        let TubeAni = true;
        let MarkAni = true;
        let IsSolo_A = false;

        // 渲染器
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setClearColor(0x000000, 0); // 第二個參數是 alpha，0 表示完全透明
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 光源
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7.5);
        scene.add(dirLight);

        // 載入模型
        const loader = new GLTFLoader();

        // 控制器
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;



        function Main() {

            ecp.placedMesh.position.set(0, 0, 0);
            scene.add(ecp.placedMesh);

            //主模型
            loader.load(
                "src/Model/SRW.glb",
                (gltf) => {
                    ecp.Set_Model_Attribute(gltf, 0);

                    //註冊UV動畫
                    ecp.Register_UV_Ani("Tube", "map", 0, .01, scene);
                    ecp.Register_UV_Ani("River", "map", 0, .001, scene);
                },
                (xhr) => {
                    console.log((xhr.loaded / xhr.total * 100) + "% loaded");
                },
                (error) => {
                    console.error("載入失敗：", error);
                }
            );

            //擊中模型打開DOM
            ecp.raycastShowDOM("Mark_A", 'InfoPanel_A', renderer, camera, scene)
            ecp.raycastShowDOM("Mark_B", 'InfoPanel_B', renderer, camera, scene)
            ecp.CameraFocusTarget("Target_A", 2, renderer, camera, scene)
            ecp.CameraFocusTarget("Target_A001", 2, renderer, camera, scene)


            // 視窗大小自適應
            window.addEventListener("resize", () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

        }


        function DOMCtrl() {
            //dom賦值
            const ids = ["ShowMark", "TubeAni", "InfoPanel", 'infobtn_A', "infobtn_B", "InfoPanel_A", "InfoPanel_B", "Solo_A"];
            const dom = ecp.mapDomByIds(ids);

            dom.InfoPanel_A.addEventListener("click", () => { ecp.GSAP_DOM_Active("InfoPanel_A", false) })
            dom.InfoPanel_B.addEventListener("click", () => { ecp.GSAP_DOM_Active("InfoPanel_B", false) })
            dom.ShowMark.addEventListener("click", () => { MarkAni = !MarkAni; ecp.GSAP_Model_Active("Mark_A", MarkAni, scene); ecp.GSAP_Model_Active("Mark_B", MarkAni, scene);})
            dom.TubeAni.addEventListener("click", () => { TubeAni = !TubeAni; ecp.Set_UV_Ani_Enabled("Tube", TubeAni); })
            dom.Solo_A.addEventListener("click", () => { IsSolo_A = !IsSolo_A; ecp.toggleSoloModel("WaterTube", IsSolo_A,scene); })

        }



        // 動畫迴圈
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            // 更新動畫時間軸
            const delta = ecp.clock.getDelta();
            ecp.mixers.forEach(mixer => mixer.update(delta));
            ecp.update_UVAni();
            renderer.render(scene, camera);
        }


        Main();
        DOMCtrl();
        animate();

    </script>
</body>

</html>